# 環境変数設定

## 管理者ログイン

- Azure AD テナントの管理者アカウント（グローバル管理者のアカウント）を利用してログインを行ってください。
- 「00.環境準備」では基本的な Azure AD, Azure の設定を行います。グローバル管理者アカウントが各 Azure サブスクリプションの管理者権限をもっていない場合には以下を行ってください。
  - Azure Portal にログインする
  - Azure Active Directory の管理画面を開く
  - プロパティ画面を開き、当該 Azure AD 配下のすべての Azure サブスクリプションに対して暗黙的に管理者権限を持つように設定する（「Azure リソースのアクセス管理」を「はい」に設定）

![picture 1](./images/9d8fbf0c9ef33be3c38fcaa72440cceaec974dcc37539f72ec4805dfe0c1d07c.png)  

``` bash
# 拡張機能の自動インストールを指定
az config set extension.use_dynamic_install=yes_without_prompt
az account clear

# ログイン処理 (Global Admin + 昇格特権設定でログイン)
az login # --tenant ${PRIMARY_DOMAIN_NAME} # --use-device
```

## 環境変数設定

- 以下のスクリプト内のプライマリドメイン名と監視通知先メールアドレスを適宜変更し、環境変数の設定を行います。
- このスクリプトは、作業の再開時に利用します。このため、上記を書き換えたファイルを手元（デスクトップなど）に保存しておいてください。（コマンドラインを途中で閉じてしまった場合、このスクリプトを再実行すれば、どのページからでも作業を再開できるようにしてあります。）

``` bash
# プライマリドメイン名
PRIMARY_DOMAIN_NAME=XXXXX.onmicrosoft.com
 
# 監視通知先メールアドレス
ALERT_EMAIL_ADDRESS=xxxx@xxxxxxx.com
 
# BCDR 用リージョン
# 0 がメインロケーション（共用リソースは 0 に配置する）
VDC_NUMBERS="0 1"
LOCATION_NAMES[0]=eastus
LOCATION_NAMES[1]=westus
LOCATION_PREFIXS[0]=eus
LOCATION_PREFIXS[1]=wus
 
# IP 帯設計
IP_HUB_PREFIXS[0]="10.0"
IP_HUB_PREFIXS[1]="10.50"
IP_MGMT_PREFIXS[0]="10.48"
IP_MGMT_PREFIXS[1]="10.98"
IP_OPS_PREFIXS[0]="10.49"
IP_OPS_PREFIXS[1]="10.99"
IP_SPOKE_A_PREFIXS[0]="10.1"
IP_SPOKE_A_PREFIXS[1]="10.51"
IP_SPOKE_B_PREFIXS[0]="10.2"
IP_SPOKE_B_PREFIXS[1]="10.52"
 
# サブスクリプションはリージョン別に分離しなくてよい（Firewall Policy などは東西共通）
SUBSCRIPTION_NAME_MGMT=subscription-mgmt
SUBSCRIPTION_NAME_HUB=subscription-hub
SUBSCRIPTION_NAME_SPOKE_A=subscription-spoke-a
SUBSCRIPTION_NAME_SPOKE_B=subscription-spoke-b
 
# グローバル一意識別のための文字列の生成
TEMP=$(echo -n $PRIMARY_DOMAIN_NAME | shasum -a 256)
UNIQUE_SUFFIX=${TEMP:0:5}
 
 
# VM 用管理者名・パスワード
ADMIN_USERNAME=azrefadmin
ADMIN_PASSWORD="p&ssw0rdp&ssw0rd"
 
# 権限分掌（ユーザアカウントの使い分け, Segregation of Duties）をするか否か
# 行う場合は適宜 az login でユーザアカウントを切り替える
FLAG_USE_SOD=true
 
# マルチサブスクリプションで管理グループを使うか否か
FLAG_USE_MG=true
 
# テスト作業の場合は
VDC_NUMBERS=0
 
# SubscriptionID を拾っておく
az account set -s "${SUBSCRIPTION_NAME_MGMT}"
SUBSCRIPTION_ID_MGMT=$(az account show --query id -o tsv)
az account set -s "${SUBSCRIPTION_NAME_HUB}"
SUBSCRIPTION_ID_HUB=$(az account show --query id -o tsv)
az account set -s "${SUBSCRIPTION_NAME_SPOKE_A}"
SUBSCRIPTION_ID_SPOKE_A=$(az account show --query id -o tsv)
az account set -s "${SUBSCRIPTION_NAME_SPOKE_B}"
SUBSCRIPTION_ID_SPOKE_B=$(az account show --query id -o tsv)
 
# 全サブスクリプション ID
# SUBSCRIPTION_IDS=$(az account subscription list --query [].subscriptionId -o tsv)
SUBSCRIPTION_IDS="$SUBSCRIPTION_ID_MGMT $SUBSCRIPTION_ID_HUB $SUBSCRIPTION_ID_SPOKE_A $SUBSCRIPTION_ID_SPOKE_B"
 
# 管理サブスクリプションに切り替え
az account set -s "${SUBSCRIPTION_NAME_MGMT}"

```
