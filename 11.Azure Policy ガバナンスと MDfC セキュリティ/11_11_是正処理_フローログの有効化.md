# 是正処理 : フローログの有効化

ここまでポリシーの適用除外について説明してきましたが、是正可能なものは適宜修正を行う必要があります。以降では、典型的な是正処理について示していきます。

まずフローログの有効化です。

```bash
 
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_plat_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
 
# FlowLog 用ストレージアカウントの作成 (リージョン別)
az account set -s "${SUBSCRIPTION_ID_MGMT}"
for i in ${VDC_NUMBERS}; do
  TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
  TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
 
  TEMP_RG_NAME="rg-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_LAW_NAME="law-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_DCE_NAME="dce-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_FLOWLOG_STORAGE_NAME="stvdcfl${TEMP_LOCATION_PREFIX}${UNIQUE_SUFFIX}"
 
  az storage account create --name ${TEMP_FLOWLOG_STORAGE_NAME} --resource-group ${TEMP_RG_NAME} --location $TEMP_LOCATION_NAME --sku Standard_LRS --allow-blob-public-access false --public-network-access Disabled --default-action Deny
done
 
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_nw_change@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
 
# FlowLog 設定
for i in ${VDC_NUMBERS}; do
  TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
  TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
 
  TEMP_RG_NAME="rg-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_LAW_NAME="law-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_FLOWLOG_STORAGE_NAME="stvdcfl${TEMP_LOCATION_PREFIX}${UNIQUE_SUFFIX}"
 
TEMP_LAW_RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourcegroups/${TEMP_RG_NAME}/providers/microsoft.operationalinsights/workspaces/${TEMP_LAW_NAME}"
TEMP_FLOWLOG_STORAGE_RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourceGroups/${TEMP_RG_NAME}/providers/Microsoft.Storage/storageAccounts/${TEMP_FLOWLOG_STORAGE_NAME}"
 
# 各リージョン内の NIC を上記ストレージと LAW に入れる
for TEMP_SUBSCRIPTION_ID in $SUBSCRIPTION_IDS; do
 
az account set -s $TEMP_SUBSCRIPTION_ID
 
# NSG を検索して NSG フローログを有効化
for TEMP_NSG_ID in $(az resource list --query "[?type == 'Microsoft.Network/networkSecurityGroups' && location == '${TEMP_LOCATION_NAME}'].id" -o tsv); do
  echo $TEMP_NSG_ID
  TEMP=(${TEMP_NSG_ID//\// })
  TEMP_RG_NAME=${TEMP[3]}
  TEMP_NSG_NAME=${TEMP[7]}
  echo $TEMP_RG_NAME $TEMP_NSG_NAME
  az network watcher flow-log create --location ${TEMP_LOCATION_NAME} --name ${TEMP_NSG_NAME} --nsg ${TEMP_NSG_ID} --workspace ${TEMP_LAW_RESOURCE_ID} --storage-account ${TEMP_FLOWLOG_STORAGE_RESOURCE_ID}  --traffic-analytics true --interval 10
done # TEMP_NSG_ID
 
done # TEMP_SUBSCRIPTION_ID
done # VDC
 
# フローログは同一リージョンの LAW に対してしかデータ送信できない

```
