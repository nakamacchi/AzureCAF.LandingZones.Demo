# Web アプリセットアップ

引き続き、前セクションで構築した IaaS VM のサーバに、Web サーバと DB サーバをセットアップし、実際に稼働する簡単な .NET アプリを載せます。主な作業は以下の通りです。

- ① vm-ops-* 作業端末に Bastion でログオンし、必要なファイルをダウンロード
- ② DB サーバ（SQL Server） のセットアップ
- ③ Web サーバ（IIS） のセットアップ

## ① vm-ops-* 作業端末に Bastion でログオンし、必要なファイルをダウンロード

- Edge ブラウザのインストール（入っていない OS の場合）
- 管理者モードで PowerShell を立ち上げて以下を実行

```PowerShell

Start-BitsTransfer -Source " https://aka.ms/edge-msi" -Destination "$env:USERPROFILE\Downloads\MicrosoftEdgeEnterpriseX64.msi"
Start-Process -Wait -Filepath msiexec.exe -Argumentlist "/i $env:UserProfile\Downloads\MicrosoftEdgeEnterpriseX64.msi /q"
start microsoft-edge:

```

- SQL Server Developer Edition のメディアと SSMS のメディアをダウンロード
  - SQL Management Studio (SSMS)
    - https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms
    - ダウンロード後、SSMS-Setup-ENU.exe を vm-test 端末上で実行して SSMS をインストールする
  - SQL Server Developer Edition
    - https://www.microsoft.com/en-us/sql-server/sql-server-downloads
    - ダウンロード後、SQL2019-SSEI-Dev.exe を実行して Download Media を実施し、ISO イメージを入手

- サンプルアプリをダウンロード
  - 以下をダウンロード
    - https://download.microsoft.com/download/a/c/8/ac880230-c893-49f3-b32d-3e70e8ac6f22/2021_05_31_FgCF_IaaS_IsolatedVNET_ReferenceArchitecture_v0.11_docs.zip
  - zip を解凍（パスワードは mskk）
    - 利用するのは以下の 2 つのファイル
      - サンプルアプリ > ASP.NETアプリ.zip (ファイルの中の publish フォルダ内に入っている ASP.NET MVC のサンプルアプリを使う)
      - サンプルアプリ > pubs_azure_timestampつき.txt
    - この 2 つのファイルを zip ファイル内から取り出しておく

## ② DB サーバ（SQL Server） のセットアップ

- Azure Portal 上で vm-db-XXX のプライベート IP アドレスを確認 (通常は 10.1.20.4 など)
- vm-ops-XXX 端末上でリモートデスクトップ (mstsc) を開き、vm-db-XXX に IP アドレスを使って接続
- SQL Server Developer Edition のメディアをコピー
- メディアをマウントし、管理者コマンドプロンプトから以下を実行（完了までしばらくかかる）

```cmd

setup.exe /Q /IACCEPTSQLSERVERLICENSETERMS /ACTION="install" /FEATURES=SQL,Tools /INSTANCENAME=MSSQLSERVER /SECURITYMODE=SQL /SAPWD="p&ssw0rdp&ssw0rd" /SQLSVCACCOUNT="NT AUTHORITY\NETWORK SERVICE" /SQLSVCSTARTUPTYPE="Automatic" /SQLSYSADMINACCOUNTS=".\azrefadmin"

```

- ポート 1433 解放

```cmd

netsh firewall set portopening protocol = TCP port = 1433 name = SQLPort mode = ENABLE profile = CURRENT

```

- TCP/IP 接続を許可
  - SQL Server Configuration Manager を開く
  - SQL Server Network Configuration > Protocols for MSSQLSERVER で TCP/IP を有効化
  - SQL Server Services > SQL Server (MSSQLSERVER) を restart

- vm-ops-XXX 端末に戻り、SSMS を起動し、以下の設定で接続
  - Server name : 10.XX.20.XX (※ 先ほど確認した vm-db-XXX の IP アドレス)
  - Authentication : SQL Server Authentication
  - Login : sa
  - Password : p&ssw0rdp&ssw0rd

- New Query でデータベースを作成

```sqlcmd

CREATE DATABASE pubs
USE pubs

```

- pubs データベースに入った後、以下のファイルの SQL を実行してデータを作成
  - pubs_azure_timestampつき.txt

## ③ Web サーバ（IIS） のセットアップ

- Azure Portal 上で vm-web-XXX のプライベート IP アドレスを確認 (通常は 10.1.10.4 など)
- vm-ops-XXX 端末上でリモートデスクトップ (mstsc) を開き、vm-web-XXX に IP アドレスを使って接続
- 管理者権限で PowerShell を開き、以下を実行

```PowerShell

Install-WindowsFeature Web-Server -IncludeManagementTools
Install-WindowsFeature Web-Asp-Net45
Install-WindowsFeature Web-Static-Content

```

- TCP/IP 接続を許可
  - 80, 443 解放

```cmd

netsh firewall set portopening protocol = TCP port = 80,443 name = WebPort mode = ENABLE profile = CURRENT

```

- vm-ops-XXX に戻り、ブラウザからアクセスを確認
  - http://10.XX.10.4/ （先ほど確認した IP アドレスを利用）
  - IIS の既定の画面が出ることを確認
- ASP.NET サンプルアプリの .zip ファイルを web サーバにコピー
  - C:\inetpub\wwwroot 下のファイルを削除
  - publish フォルダ下の中身を C:\inetpub\wwwroot 下にコピー
  - web.config ファイル内の接続文字列を書き換え
    - 下記の中のサーバ名、パスワードを書き換える
    - 下記の通り、TrustServerCertificate=True の設定を入れておく

```web.config

  <connectionStrings>
    <add name="PubsConnection" providerName="System.Data.SqlClient" connectionString="Server=tcp:vm-db-XXX,1433;Initial Catalog=pubs;Persist Security Info=False;User ID=sa;Password=p&amp;ssw0rdp&amp;ssw0rd;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=True;ConnectRetryCount=3;ConnectRetryInterval=30;Connection Timeout=60;Language=Japanese;" />
  </connectionStrings>

```

- vm-ops-XXX に戻り、ブラウザからアクセスを確認
  - http://10.1.10.4/ （先ほど確認した IP アドレスを利用）
  - アプリが動作することを確認
- コマンドライン（PowerShell ではなく cmd ）からサーバに継続的にリクエスト発行し、サーバを利用している状況を作る

```cmd

for /l %i in () do (timeout 5 & curl http://10.1.10.4/Home/Ping)

```
