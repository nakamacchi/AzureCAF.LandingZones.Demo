# フィルタルール (FQDN) 設定

Azure Firewall のフィルタルールを設定します。ここでは Windows Update をはじめとする基本的な穴開けに加えて、Guest Configuration agent や Log Analytics Workspace への経路などの確保を行っています。

```bash
# 共通基盤管理チーム／① 初期構築時の作業アカウントに切り替え
if ${FLAG_USE_SOD} ; then az account clear ; az login -u "user_plat_dev@${PRIMARY_DOMAIN_NAME}" -p "${ADMIN_PASSWORD}" ; fi
 
# ハブサブスクリプションに切り替え
az account set -s "${SUBSCRIPTION_ID_HUB}"
 
# FQDN 開放
# 開放している FQDN は以下の通り
# Windows Update, Qualys, CRL, MDfE, Ubuntu Update
# KMS への通信も通す (Windows ライセンス認証)
# kms.core.windows.net:1688
# 20.118.99.224, 40.83.235.53, 23.102.135.246
# https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/custom-routes-enable-kms-activation#solution
 
TEMP_MAIN_LOCATION=${LOCATION_NAMES[0]}
TEMP_MAIN_RG_NAME="rg-hub-${LOCATION_PREFIXS[0]}"
TEMP_MAIN_FWP_NAME="fwp-fw-hub-${LOCATION_PREFIXS[0]}"
 
cat <<EOF > tmp.json
{
  "\$schema": " https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "resources": [
    {
      "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
      "apiVersion": "2020-07-01",
      "name": "${TEMP_MAIN_FWP_NAME}/DefaultApplicationRuleCollectionGroup",
      "location": "${TEMP_MAIN_LOCATION}",
      "properties": {
        "priority": 1000,
        "ruleCollections": [
          {
            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
            "action": { "type": "Allow" },
            "name": "WindowsOS",
            "priority": 30000,
            "rules": [
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "WindowsUpdate", "fqdnTags": [ "WindowsUpdate", "WindowsDiagnostics", "MicrosoftActiveProtectionService" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "CRL",  "targetFqdns": [ "rb.symcd.com", "s.symcd.com", "ts-ocsp.ws.symantec.com", "ts-crl.ws.symantec.com", "crl.microsoft.com", "ocsp.digicert.com", "crl4.digicert.com", "crl3.digicert.com", "mscrl.microsoft.com", "*.verisign.com", "*.entrust.net", "*.crl3.digicert.com", "*.crl4.digicert.com", "*.ocsp.digicert.com", "*.www.d-trust.net", "*.root-c3-ca2-2009.ocsp.d-trust.net", "*.crl.microsoft.com", "*.oneocsp.microsoft.com", "*.ocsp.msocsp.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "UserExperienceAndDiagnosticsComponents",  "targetFqdns": [ "v10c.events.data.microsoft.com", "v10.events.data.microsoft.com", "v10.vortex-win.data.microsoft.com", "vortex-win.data.microsoft.com", "v20.events.data.microsoft.com", "settings-win.data.microsoft.com", "watson.telemetry.microsoft.com", "umwatsonc.events.data.microsoft.com", "*-umwatsonc.events.data.microsoft.com", "ceuswatcab01.blob.core.windows.net", "ceuswatcab02.blob.core.windows.net", "eaus2watcab01.blob.core.windows.net", "eaus2watcab02.blob.core.windows.net", "weus2watcab01.blob.core.windows.net", "weus2watcab02.blob.core.windows.net", "login.live.com", "oca.microsoft.com", "kmwatsonc.telemetry.microsoft.com", "*-kmwatsonc.telemetry.microsoft.com", "settings-win.data.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "InternetConnectTest",  "targetFqdns": [ "www.msftconnecttest.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "SmartScreen",  "targetFqdns": [ "*.smartscreen.microsoft.com", "urs.microsoft.com", "unitedstates.smartscreen-prod.microsoft.com", "*.urs.microsoft.com", "checkappexec.microsoft.com", "wdcpalt.microsoft.com", "smartscreen-prod.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "LicenseActivation",  "targetFqdns": [ "activation.sls.microsoft.com", "crl.microsoft.com", "validation.sls.microsoft.com", "activation-v2.sls.microsoft.com", "validation-v2.sls.microsoft.com", "displaycatalog.mp.microsoft.com", "licensing.mp.microsoft.com", "purchase.mp.microsoft.com", "displaycatalog.md.mp.microsoft.com", "licensing.md.mp.microsoft.com", "purchase.md.mp.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "MicrosoftEdge",  "targetFqdns": [ "config.edge.skype.com", "msedge.api.cdp.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Windows Push Notification",  "targetFqdns": [ "client.wns.windows.com" ] }
            ]
          },
          {
            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
            "action": { "type": "Allow" },
            "name": "UbuntuOS",
            "priority": 30100,
            "rules": [
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "UpdatePackage",  "targetFqdns": [ "security.ubuntu.com", "archive.ubuntu.com", "azure.archive.ubuntu.com", "motd.ubuntu.com", "*.security.ubuntu.com", "*.archive.ubuntu.com", "entropy.ubuntu.com", "api.snapcraft.io", "changelogs.ubuntu.com" ] }
            ]
          },
          {
            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
            "action": { "type": "Allow" },
            "name": "MDfS(MDE)",
            "priority": 20000,
            "rules": [
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "CRL",  "targetFqdns": [ "crl.microsoft.com", "ctldl.windowsupdate.com", "www.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Common",  "targetFqdns": [ "events.data.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Common (Mac/Linux)",  "targetFqdns": [ "x.cp.wd.microsoft.com", "cdn.x.cp.wd.microsoft.com", "officecdn-microsoft-com.akamaized.net" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Common (Linux)",  "targetFqdns": [ "packages.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Microsoft Defender for Endpoint US",  "targetFqdns": [ "unitedstates.x.cp.wd.microsoft.com", "us-v20.events.data.microsoft.com", "winatp-gw-cus.microsoft.com", "winatp-gw-eus.microsoft.com", "winatp-gw-cus3.microsoft.com", "winatp-gw-eus3.microsoft.com", "automatedirstrprdcus.blob.core.windows.net", "automatedirstrprdeus.blob.core.windows.net", "automatedirstrprdcus3.blob.core.windows.net", "automatedirstrprdeus3.blob.core.windows.net", "ussus1eastprod.blob.core.windows.net", "ussus2eastprod.blob.core.windows.net", "ussus3eastprod.blob.core.windows.net", "ussus4eastprod.blob.core.windows.net", "wsus1eastprod.blob.core.windows.net", "wsus2eastprod.blob.core.windows.net", "ussus1westprod.blob.core.windows.net", "ussus2westprod.blob.core.windows.net", "ussus3westprod.blob.core.windows.net", "ussus4westprod.blob.core.windows.net", "wsus1westprod.blob.core.windows.net", "wsus2westprod.blob.core.windows.net" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Microsoft Defender for Endpoint EU",  "targetFqdns": [ "europe.x.cp.wd.microsoft.com", "eu-v20.events.data.microsoft.com", "winatp-gw-neu.microsoft.com", "winatp-gw-weu.microsoft.com", "winatp-gw-neu3.microsoft.com", "winatp-gw-weu3.microsoft.com", "automatedirstrprdneu.blob.core.windows.net", "automatedirstrprdweu.blob.core.windows.net", "automatedirstrprdneu3.blob.core.windows.net", "automatedirstrprdweu3.blob.core.windows.net", "usseu1northprod.blob.core.windows.net", "wseu1northprod.blob.core.windows.net", "usseu1westprod.blob.core.windows.net", "wseu1westprod.blob.core.windows.net" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Microsoft Defender for Endpoint UK",  "targetFqdns": [ "unitedkingdom.x.cp.wd.microsoft.com", "uk-v20.events.data.microsoft.com", "winatp-gw-uks.microsoft.com", "winatp-gw-ukw.microsoft.com", "automatedirstrprduks.blob.core.windows.net", "automatedirstrprdukw.blob.core.windows.net", "ussuk1southprod.blob.core.windows.net", "wsuk1southprod.blob.core.windows.net", "ussuk1westprod.blob.core.windows.net", "wsuk1westprod.blob.core.windows.net" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Required when using Security Management for Microsoft Defender for Endpoint",  "targetFqdns": [ "enterpriseregistration.windows.net", "*.dm.microsoft.com", "login.microsoftonline.com" ] }
            ]
          },
          {
            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
            "action": { "type": "Allow" },
            "name": "MDfS(DefenderAntivirus)",
            "priority": 20100,
            "rules": [
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "MU / WU",  "targetFqdns": [ "go.microsoft.com", "definitionupdates.microsoft.com", "www.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "Symbols",  "targetFqdns": [ "msdl.microsoft.com" ] },
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 } ], "sourceAddresses": [ "*" ], "name": "MAPS",  "targetFqdns": [ "*.wdcp.microsoft.com", "*.wd.microsoft.com" ] }
            ]
          },
          {
            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
            "action": { "type": "Allow" },
            "name": "MDfS(Qualys)",
            "priority": 20200,
            "rules": [
              { "ruleType": "ApplicationRule", "protocols": [ { "protocolType": "Https", "port": 443 }, { "protocolType": "Http", "port": 80 } ], "sourceAddresses": [ "*" ], "name": "QualysCloudScanner",  "targetFqdns": [ "qagpublic.qg3.apps.qualys.com", "qagpublic.qg2.apps.qualys.eu" ] }
            ]
          }
        ]
      }
    }
  ]
}
EOF
az deployment group create --name "${TEMP_MAIN_FWP_NAME}_DefaultApplicationRuleCollectionGroup" --resource-group ${TEMP_MAIN_RG_NAME} --template-file tmp.json
 
 
# ルールコレクショングループはまとめて一括では作成できないので順を追って作成。
cat <<EOF > tmp.json
{
  "\$schema": " https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "resources": [
    {
      "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
      "apiVersion": "2020-07-01",
      "name": "${TEMP_MAIN_FWP_NAME}/DefaultNetworkRuleCollectionGroup",
      "location": "${TEMP_MAIN_LOCATION}",
      "properties": {
        "priority": 2000,
        "ruleCollections": [
          {
            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
            "action": { "type": "Allow" },
            "name": "KMS",
            "priority": 30000,
            "rules": [
              { "ruleType": "NetworkRule", "ipProtocols": [ "TCP" ], "sourceAddresses": [ "*" ], "name": "KMS", "destinationPorts": [ 1688 ],  "destinationAddresses": [ "20.118.99.224", "40.83.235.53", "23.102.135.246" ] }
            ]
          }
        ]
      }
    }
  ]
}
EOF
az deployment group create --name "${TEMP_MAIN_FWP_NAME}_DefaultNetworkRuleCollectionGroup" --resource-group ${TEMP_MAIN_RG_NAME} --template-file tmp.json
 
# LAW, DCE への経路確保
# VDC LAW への FQDN 経路開放（正副両方へ流せるようにしておく）
TEMP_MAIN_LOCATION=${LOCATION_NAMES[0]}
TEMP_MAIN_RG_NAME="rg-hub-${LOCATION_PREFIXS[0]}"
TEMP_MAIN_FWP_NAME="fwp-fw-hub-${LOCATION_PREFIXS[0]}"
 
for i in ${VDC_NUMBERS}; do
  TEMP_LOCATION_NAME=${LOCATION_NAMES[$i]}
  TEMP_LOCATION_PREFIX=${LOCATION_PREFIXS[$i]}
 
  TEMP_RG_NAME="rg-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_LAW_NAME="law-vdc-${TEMP_LOCATION_PREFIX}"
  TEMP_DCE_NAME="dce-vdc-${TEMP_LOCATION_PREFIX}"
 
TEMP_LAW_RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourcegroups/rg-vdc-${TEMP_LOCATION_PREFIX}/providers/microsoft.operationalinsights/workspaces/${TEMP_LAW_NAME}"
  TEMP_DCE_ID="/subscriptions/${SUBSCRIPTION_ID_MGMT}/resourcegroups/rg-vdc-${TEMP_LOCATION_PREFIX}/providers/microsoft.insights/datacollectionendpoints/dce-vdc-${TEMP_LOCATION_PREFIX}"
 
  TEMP_LAW_CUSTOMER_ID=$(az monitor log-analytics workspace show --ids ${TEMP_LAW_RESOURCE_ID} --query customerId -o tsv)
  TEMP_DCE_CONFIG_EP=$(az monitor data-collection endpoint show --ids ${TEMP_DCE_ID} --query configurationAccess.endpoint -o tsv)
  TEMP_DCE_CONFIG_FQDN=${TEMP_DCE_CONFIG_EP:8}
  TEMP_DCE_INGEST_EP=$(az monitor data-collection endpoint show --ids ${TEMP_DCE_ID} --query logsIngestion.endpoint -o tsv)
  TEMP_DCE_INGEST_FQDN=${TEMP_DCE_INGEST_EP:8}
 
  TEMP_COLLECTION_PRIORITY="2030${i}"
 
# 共通ポリシーに対して設定
az network firewall policy rule-collection-group collection add-filter-collection \
	--resource-group ${TEMP_MAIN_RG_NAME} --policy-name "${TEMP_MAIN_FWP_NAME}" --rcg-name "DefaultApplicationRuleCollectionGroup" \
	--name "Azure Monitor Agent" --rule-type ApplicationRule --collection-priority ${TEMP_COLLECTION_PRIORITY} --action Allow \
	--rule-name "${TEMP_LAW_NAME}" \
	--target-fqdns "global.handler.control.monitor.azure.com" "${TEMP_LOCATION_NAME}.handler.control.monitor.azure.com" "management.azure.com" "${TEMP_LOCATION_NAME}.monitoring.azure.com" "${TEMP_LAW_CUSTOMER_ID}.ods.opinsights.azure.com" "${TEMP_DCE_CONFIG_FQDN}" "${TEMP_DCE_INGEST_FQDN}" \
	--source-addresses "*" --protocols Http=80 Https=443
done
 
# Guest Configuration (Azure Policy) が利用する FQDN を開放
# https://learn.microsoft.com/en-us/azure/governance/machine-configuration/overview#network-requirements
az network firewall policy rule-collection-group collection add-filter-collection \
	--resource-group ${TEMP_MAIN_RG_NAME} --policy-name ${TEMP_MAIN_FWP_NAME} --rcg-name "DefaultApplicationRuleCollectionGroup" \
	--name "Guest Configuration Agent" --rule-type ApplicationRule --collection-priority 20400 --action Allow \
	--rule-name "Guest Configuration Agent" \
	--target-fqdns "agentserviceapi.guestconfiguration.azure.com" "*.guestconfiguration.azure.com" "oaasguestconfigac2s1.blob.core.windows.net" "oaasguestconfigacs1.blob.core.windows.net" "oaasguestconfigaes1.blob.core.windows.net" "oaasguestconfigases1.blob.core.windows.net" "oaasguestconfigbrses1.blob.core.windows.net" "oaasguestconfigbrss1.blob.core.windows.net" "oaasguestconfigccs1.blob.core.windows.net" "oaasguestconfigces1.blob.core.windows.net" "oaasguestconfigcids1.blob.core.windows.net" "oaasguestconfigcuss1.blob.core.windows.net" "oaasguestconfigeaps1.blob.core.windows.net" "oaasguestconfigeas1.blob.core.windows.net" "oaasguestconfigeus2s1.blob.core.windows.net" "oaasguestconfigeuss1.blob.core.windows.net" "oaasguestconfigfcs1.blob.core.windows.net" "oaasguestconfigfss1.blob.core.windows.net" "oaasguestconfiggewcs1.blob.core.windows.net" "oaasguestconfiggns1.blob.core.windows.net" "oaasguestconfiggwcs1.blob.core.windows.net" "oaasguestconfigjiws1.blob.core.windows.net" "oaasguestconfigjpes1.blob.core.windows.net" "oaasguestconfigjpws1.blob.core.windows.net" "oaasguestconfigkcs1.blob.core.windows.net" "oaasguestconfigkss1.blob.core.windows.net" "oaasguestconfigncuss1.blob.core.windows.net" "oaasguestconfignes1.blob.core.windows.net" "oaasguestconfignres1.blob.core.windows.net" "oaasguestconfignrws1.blob.core.windows.net" "oaasguestconfigqacs1.blob.core.windows.net" "oaasguestconfigsans1.blob.core.windows.net" "oaasguestconfigscuss1.blob.core.windows.net" "oaasguestconfigseas1.blob.core.windows.net" "oaasguestconfigsecs1.blob.core.windows.net" "oaasguestconfigsfns1.blob.core.windows.net" "oaasguestconfigsfws1.blob.core.windows.net" "oaasguestconfigsids1.blob.core.windows.net" "oaasguestconfigstzns1.blob.core.windows.net" "oaasguestconfigswcs1.blob.core.windows.net" "oaasguestconfigswns1.blob.core.windows.net" "oaasguestconfigswss1.blob.core.windows.net" "oaasguestconfigswws1.blob.core.windows.net" "oaasguestconfiguaecs1.blob.core.windows.net" "oaasguestconfiguaens1.blob.core.windows.net" "oaasguestconfigukss1.blob.core.windows.net" "oaasguestconfigukws1.blob.core.windows.net" "oaasguestconfigwcuss1.blob.core.windows.net" "oaasguestconfigwes1.blob.core.windows.net" "oaasguestconfigwids1.blob.core.windows.net" "oaasguestconfigwus2s1.blob.core.windows.net" "oaasguestconfigwus3s1.blob.core.windows.net" "oaasguestconfigwuss1.blob.core.windows.net"  \
	--source-addresses "*" --protocols Https=443
 
 
# Docker のインストールと Hello World 用 FQDN 解放
az network firewall policy rule-collection-group collection add-filter-collection \
	--resource-group ${TEMP_MAIN_RG_NAME} --policy-name ${TEMP_MAIN_FWP_NAME} --rcg-name "DefaultApplicationRuleCollectionGroup" \
	--name "Docker" --rule-type ApplicationRule --collection-priority 40000 --action Allow \
	--rule-name "Docker" \
	--target-fqdns "download.docker.com" "auth.docker.io" "registry-1.docker.io" "production.cloudflare.docker.com" \
	--source-addresses "*" --protocols Https=443
 
# 日本語化パッケージのダウンロード FQDN の解放
# https://github.com/tksh164/change-windows-language-regional-settings
az network firewall policy rule-collection-group collection rule add \
	--resource-group "${TEMP_MAIN_RG_NAME}" --policy-name "${TEMP_MAIN_FWP_NAME}" --rcg-name "DefaultApplicationRuleCollectionGroup" \
	--collection-name "WindowsOS" --rule-type ApplicationRule \
	--name "LanguagePackage" \
	--target-fqdns "software-static.download.prss.microsoft.com" \
	--source-addresses "*" --protocols Https=443
 
# DNS プロキシを有効化
az network firewall policy update --name ${TEMP_MAIN_FWP_NAME} --resource-group ${TEMP_MAIN_RG_NAME} --enable-dns-proxy true
 
 

```
